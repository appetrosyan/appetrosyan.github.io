import{_ as a,c as e,a as n,o as t}from"./app-DYOwYO0n.js";const o={};function i(p,s){return t(),e("div",null,s[0]||(s[0]=[n(`<h1 id="how-to-set-up-magit-forge" tabindex="-1"><a class="header-anchor" href="#how-to-set-up-magit-forge"><span>How to set up Magit forge</span></a></h1><p>Magit is an excellent package with incredible depth.</p><p>Sadly it is accompanied by the most unreadable documentation which is saying something, given that it&#39;s an Emacs package.</p><p>Here I will detail an example configuration to set up a GitHub to magit interface.</p><h1 id="github" tabindex="-1"><a class="header-anchor" href="#github"><span>GitHub</span></a></h1><p>This is the default, and probably most relevant.</p><h2 id="preliminary-github-specific-configuration" tabindex="-1"><a class="header-anchor" href="#preliminary-github-specific-configuration"><span>Preliminary GitHub-specific configuration</span></a></h2><p>Magit, as is common, requires you to generate a token.</p><p>While a Firefox plugin will probably have a link and an explanation, to understand what to do in <code>magit</code> requires one to dig through an inordinate amount of API documentation.</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line"><span class="token function">git</span> config <span class="token parameter variable">--global</span> github.user <span class="token operator">&lt;</span>you-user-name<span class="token operator">&gt;</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>in my case it&#39;s:</p><div class="language-bash line-numbers-mode" data-highlighter="prismjs" data-ext="sh"><pre><code><span class="line">appetrosyan</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Next, head to <a href="https://github.com/settings/tokens/new" target="_blank" rel="noopener noreferrer">GitHub</a> and generate a new token:</p><p>Then you should perhaps consider making it visible to Emacs.</p><p>The <code>magit</code> documentation offers the worst possible way to store the information; via <code>~/.authinfo</code> as a plain text file. It&#39;s unencrypted, it pollutes your home folder, but also, if you have a syntax error anywhere, you&#39;re fucked.</p><p>A much better option and one that <em>almost every other</em> program uses, is to use the secrets service. More on that <a href="https://www.gnu.org/software/emacs/manual/html_mono/auth.html#Secret-Service-API" target="_blank" rel="noopener noreferrer">here</a>.</p><p>Now if you&#39;re not used to Emacs&#39; documentation style, where instead of saying &quot;you put X into Y&quot;, there&#39;s a section Y, that never mentioned X, and the X is implicit from the module path, unless the macro is quoted... Yes I hate it too.</p><p>What this tells you is that you should integrate the stuff with KeePassXC, as can be seen from the previous article.</p><p>It&#39;s not at all hard to do, graphically speaking, but the amount of manual fuckery that needs to be done is truly confounding. What&#39;s even worse, is that you as the designer of <code>forge</code> <strong>know</strong> exactly what needs to be done, and yet you choose to be obtuse.</p><div class="hint-container info"><p class="hint-container-title">TODO</p><p>Create a PR and add a neater way to do these things.</p></div><p>So without further ado, you must first create a new entry, and that&#39;s easy: set the <code>TITLE</code> to <code>github_api_token</code>. We will use it later in the Emacs configuration.</p><p>Next you want to set the <code>password</code> to the token.</p><p>Next, you probably want to go into <code>Advanced</code> and write the following mappings. Set <code>machine</code> to <code>api.github.com</code>. Next set <code>login</code> to <code>&lt;your-user-name&gt;^forge</code>. I set it to <code>appetrosyan^forge</code>.</p><p>At this point, you can verify that everything is correct, by going to <code>secrets-show-secrets</code> in your Emacs, and it should work.</p><h2 id="setting-up-magit-forge" tabindex="-1"><a class="header-anchor" href="#setting-up-magit-forge"><span>Setting up Magit Forge</span></a></h2><div class="hint-container tip"><p class="hint-container-title">Tips</p><p>A large part of what follows is an example of how an engineer approaches a configuration problem, and not strictly necessary for doing the configuration.</p></div><p>I&#39;ll assume that you have installed <code>magit</code> via <code>use-package</code>. If you didn&#39;t, you&#39;re probably still fine, but I&#39;d recommend that you use it.</p><p>Firstly, add</p><div class="language-elisp line-numbers-mode" data-highlighter="prismjs" data-ext="elisp"><pre><code><span class="line"><span class="token punctuation">(</span><span class="token keyword">use-package</span> forge</span>
<span class="line">  <span class="token lisp-property property">:after</span> magit</span>
<span class="line">  <span class="token lisp-property property">:ensure</span> <span class="token boolean">t</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>and eval using <code>C-x C-e</code>. This will install the package, and allow you to do what you need to do.</p><p>Next, we&#39;re going to disentangle the &quot;how-to-add-the-token&quot; part.</p><p>You probably need to set the <code>auth-sources</code> variable. The reason, is that the defaults are completely unsuitable and insecure. Instead we shall use <code>secrets:github_api_token</code>.</p><div class="language-elisp line-numbers-mode" data-highlighter="prismjs" data-ext="elisp"><pre><code><span class="line"><span class="token punctuation">(</span><span class="token keyword">use-package</span> forge</span>
<span class="line">  <span class="token lisp-property property">:after</span> magit</span>
<span class="line">  <span class="token lisp-property property">:config</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token keyword">setq</span> auth-sources <span class="token punctuation">&#39;(</span><span class="token string">&quot;secrets:github_api_token&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token lisp-property property">:ensure</span> <span class="token boolean">t</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we can verify by evaluating.</p><h2 id="initial-pull" tabindex="-1"><a class="header-anchor" href="#initial-pull"><span>Initial pull</span></a></h2><p>At this point the thing should have been configured. So, just do the initial pull, as outlined in the docs: open magit <code>C-x g</code>, and then do <code>f n</code>. In principle, things should work.</p><h2 id="the-importance-of-good-error-messages" tabindex="-1"><a class="header-anchor" href="#the-importance-of-good-error-messages"><span>The importance of good error messages</span></a></h2><p>The problem here is threefold, trying to do an initial pull results in the following error message.</p><div class="language-console line-numbers-mode" data-highlighter="prismjs" data-ext="console"><pre><code><span class="line">ghub--token: Required Github token (&quot;appetrosyan^forge&quot; for &quot;api.github.com&quot;) does not exist.</span>
<span class="line">See https://magit.vc/manual/ghub/Getting-Started.html</span>
<span class="line">or (info &quot;(ghub)Getting Started&quot;) for instructions.</span>
<span class="line">(The setup wizard no longer exists.)</span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Problem 1: You never explained why the wizard no longer exists. You alluded to an explanation existing and assumed it&#39;d be enough (and for most people it is).</p><p>Problem 2: You provide the most generic fucking error message possible. If I want to do this semi-portably and in some ways with some semblance of security, I need to know how to point your dumb fucking function at the right structure to get the information. This is a problem with the Emacs API, because ideally the way to configure this shouldn&#39;t be to set a variable to a vague file that contains the authentication info, it should provide you with an easy way to retrieve information from the secret service, and a way to map that information. The reason mapping should be done manually by the user, is because you already assume that the user is capable of doing the mapping when creating the <code>.authinfo</code> file. In general it&#39;s a good idea to either give user a step-by-step guide on how to set stuff up properly, or you should document every possible approach and allow users to debug the system with intermediate approaches.</p><p>Problem 3: The mappings don&#39;t agree on concepts. There&#39;s <code>machine</code> and there&#39;s <code>URL</code>. There&#39;s a <code>login</code> field and then there&#39;s <code>User Name</code>. As for the error message, here&#39;s some positives:</p><ul><li>It gives me a precise name for the function, meaning that I can just look through the code and figure out where you were looking.</li><li>It tells me (or rather confirms to me) that a piece of data called the <code>login</code> should look like <code>appetrosyan^forge</code>.</li><li>It tells me that the <code>url</code> or some such must be set to <code>api.github.com</code>.</li><li>It points me to two source of documentation: one online, and one offline.</li><li>It also tells me that there <em>was</em> a setup wizard that made my life a lot easier, it just vanished.</li></ul><p>This is surprisingly good, not only for an Emacs package, but for software in general. I would argue that this opens an opportunity to improve the documentation.</p><p>Now to figure out how to fix the problem, I call help. But not just any help, but <code>helpful</code>. The reason why this package is bloody useful, has to do with the fact that it not only shows you the often completely incorrect docstring, or what the function is intended to do, but also what it actually does; and in this case, it&#39;s</p><div class="language-elisp line-numbers-mode" data-highlighter="prismjs" data-ext="elisp"><pre><code><span class="line"><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">ghub--token</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">host</span> <span class="token argument variable">username</span> <span class="token argument variable">package</span> <span class="token other-marker-vars"><span class="token lisp-marker">&amp;optional</span> <span class="token argument variable">nocreate</span> <span class="token argument variable">forge</span></span></span><span class="token punctuation">)</span></span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token keyword">let*</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">user</span> <span class="token punctuation">(</span><span class="token car">ghub--ident</span> username package<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">		 <span class="token punctuation">(</span><span class="token car">token</span></span>
<span class="line">		  <span class="token punctuation">(</span><span class="token keyword">or</span> <span class="token punctuation">(</span><span class="token car">car</span> <span class="token punctuation">(</span><span class="token car">ghub--auth-source-get</span> <span class="token punctuation">(</span><span class="token car">list</span> <span class="token lisp-property property">:secret</span><span class="token punctuation">)</span></span>
<span class="line">					 <span class="token lisp-property property">:host</span> host <span class="token lisp-property property">:user</span> user<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">			  <span class="token punctuation">(</span><span class="token car">progn</span></span>
<span class="line">				<span class="token comment">;; Auth-Source caches the information that there is no</span></span>
<span class="line">				<span class="token comment">;; value, but in our case that is a situation that needs</span></span>
<span class="line">				<span class="token comment">;; fixing so we want to keep trying by invalidating that</span></span>
<span class="line">				<span class="token comment">;; information.</span></span>
<span class="line">				<span class="token comment">;; The (:max 1) is needed and has to be placed at the</span></span>
<span class="line">				<span class="token comment">;; end for Emacs releases before 26.1.  #24 #64 #72</span></span>
<span class="line">				<span class="token punctuation">(</span><span class="token car">auth-source-forget</span> <span class="token punctuation">(</span><span class="token car">list</span> <span class="token lisp-property property">:host</span> host <span class="token lisp-property property">:user</span> user <span class="token lisp-property property">:max</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">				<span class="token punctuation">(</span><span class="token keyword">and</span> <span class="token punctuation">(</span><span class="token keyword">not</span> nocreate<span class="token punctuation">)</span></span>
<span class="line">					 <span class="token punctuation">(</span><span class="token keyword">error</span> &quot;\\</span>
<span class="line">Required %s token <span class="token punctuation">(</span>\\<span class="token string">&quot;%s\\&quot; for \\&quot;%s\\&quot;) does not exist.</span>
<span class="line">See https://magit.vc/manual/ghub/Getting-Started.html</span>
<span class="line">or (info \\&quot;(ghub)Getting Started\\&quot;) for instructions.</span>
<span class="line">\\(The setup wizard no longer exists.)&quot;</span></span>
<span class="line">							<span class="token punctuation">(</span><span class="token car">capitalize</span> <span class="token punctuation">(</span><span class="token car">symbol-name</span> <span class="token punctuation">(</span><span class="token keyword">or</span> forge <span class="token quoted-symbol variable symbol">&#39;github</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">							user host<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">(</span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token car">functionp</span> token<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token car">funcall</span> token<span class="token punctuation">)</span> token<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Splendid, now I know that there&#39;s a function where the token behaviour is hard-coded, called <code>ghub--auth-source-get</code>. Moreso, given the error message I can map the values: <code>host</code> is <code>api.github.com</code>, <code>user</code> is <code>appetrosyan^forge</code> and Github is considered the default. This is extremely valuable information, that is possible to retrieve thanks to the good error message.</p><p>Now the next step is to figure out what <code>ghub--auth-source-get</code> is doing.</p><div class="language-elisp line-numbers-mode" data-highlighter="prismjs" data-ext="elisp"><pre><code><span class="line"><span class="token punctuation">(</span><span class="token defun"><span class="token keyword">defun</span> <span class="token function">ghub--auth-source-get</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">keys</span> <span class="token rest-vars"><span class="token lisp-marker">&amp;rest</span> <span class="token argument variable">spec</span></span></span><span class="token punctuation">)</span></span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token declare keyword">declare</span> <span class="token punctuation">(</span><span class="token car">indent</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token keyword">let</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token car">plist</span> <span class="token punctuation">(</span><span class="token car">car</span> <span class="token punctuation">(</span><span class="token car">apply</span> <span class="token quoted-symbol variable symbol">#&#39;auth-source-search</span></span>
<span class="line">						   <span class="token punctuation">(</span><span class="token keyword">append</span> spec <span class="token punctuation">(</span><span class="token car">list</span> <span class="token lisp-property property">:max</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">	<span class="token punctuation">(</span><span class="token car">mapcar</span> <span class="token punctuation">(</span><span class="token lambda"><span class="token keyword">lambda</span> <span class="token punctuation">(</span><span class="token arguments"><span class="token argument variable">k</span></span><span class="token punctuation">)</span></span></span>
<span class="line">			  <span class="token punctuation">(</span><span class="token car">plist-get</span> plist k<span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line">			keys<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>A bit less informative, but now it forwards to <code>auth-source-search</code>, which is a library function. It&#39;s source code is much too complicated, so I won&#39;t quote it here. I will however say that it should create what we need. So, what do we do?</p><p>We adjust the information so that it matches what it expects. It has the word <code>:host</code> and that makes sense. It has the word <code>:user</code> and that makes sense too. I&#39;d also add the word <code>token</code> to the list.</p><p>So let&#39;s try again!</p><p>No. Same error message.</p><p>Now the trouble isn&#39;t that Jonas has provided a bad error message, given the architecture he&#39;s done the best he could. The trouble is that the layers of abstraction make debugging these sorts of things harder than they need to be.</p><p>Perhaps there&#39;s a mistake in how <code>auth-sources</code> is customized. Indeed the manual states so;</p><blockquote><p>It&#39;s best to customize this with M-x customize-variable because the choices can get pretty complex.</p></blockquote><p>Let&#39;s do that! Aand here&#39;s our problem! Customizing it to use the default secrets API is the correct approach. Now to make the customization persistent, we should also consider setting it via <code>setq</code> or better, via the <code>:custom</code> keyword.</p><h2 id="doing-the-right-thing-finally" tabindex="-1"><a class="header-anchor" href="#doing-the-right-thing-finally"><span>Doing the right thing finally</span></a></h2><p>It turns out that setting the <code>auth-sources</code> variable to <code>default</code> is all we need to do. This gives us the final form:</p><div class="language-elisp line-numbers-mode" data-highlighter="prismjs" data-ext="elisp"><pre><code><span class="line"><span class="token punctuation">(</span><span class="token keyword">use-package</span> forge</span>
<span class="line">  <span class="token lisp-property property">:after</span> magit</span>
<span class="line">  <span class="token lisp-property property">:custom</span></span>
<span class="line">  <span class="token punctuation">(</span><span class="token car">auth-sources</span> <span class="token punctuation">&#39;(</span><span class="token car">default</span><span class="token punctuation">)</span> <span class="token string">&quot;We use the secret service API&quot;</span><span class="token punctuation">)</span></span>
<span class="line">  <span class="token lisp-property property">:ensure</span> <span class="token boolean">t</span><span class="token punctuation">)</span></span>
<span class="line"></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Now we can verify that forge works! We can also verify that forge works only on GitHub.</p><h1 id="gitlab" tabindex="-1"><a class="header-anchor" href="#gitlab"><span>GitLab</span></a></h1>`,62)]))}const c=a(o,[["render",i],["__file","magit-forge.html.vue"]]),r=JSON.parse(`{"path":"/posts/magit-forge.html","title":"How to set up Magit forge","lang":"en-GB","frontmatter":{"category":["Emacs","Work","Tooling"],"date":["2024-01-16T00:00:00.000Z"]},"headers":[{"level":2,"title":"Preliminary GitHub-specific configuration","slug":"preliminary-github-specific-configuration","link":"#preliminary-github-specific-configuration","children":[]},{"level":2,"title":"Setting up Magit Forge","slug":"setting-up-magit-forge","link":"#setting-up-magit-forge","children":[]},{"level":2,"title":"Initial pull","slug":"initial-pull","link":"#initial-pull","children":[]},{"level":2,"title":"The importance of good error messages","slug":"the-importance-of-good-error-messages","link":"#the-importance-of-good-error-messages","children":[]},{"level":2,"title":"Doing the right thing finally","slug":"doing-the-right-thing-finally","link":"#doing-the-right-thing-finally","children":[]}],"git":{"updatedTime":1742748808000,"contributors":[{"name":"Aleksandr Petrosyan","username":"","email":"ap886@cantab.ac.uk","commits":3}],"changelog":[{"hash":"2504feacfc8e83978d0f3b7c3a3f7df06b5b48c6","time":1742748808000,"email":"ap886@cantab.ac.uk","author":"Aleksandr Petrosyan","message":"[vuepress]: Migrating articles"},{"hash":"bc5bda253540556643ed855b2cd5c7ee23c67889","time":1742747283000,"email":"ap886@cantab.ac.uk","author":"Aleksandr Petrosyan","message":"[vuepress]: Initial migration"},{"hash":"d17205e935e8ca259baaf41af64a0e55ff0eacdb","time":1705425775000,"email":"ap886@cantab.ac.uk","author":"Aleksandr Petrosyan","message":"[guide]: <code>magit forge</code>"}]},"filePathRelative":"posts/magit-forge.md","excerpt":"\\n<p>Magit is an excellent package with incredible depth.</p>\\n<p>Sadly it is accompanied by the most unreadable documentation which is saying something, given that it's an Emacs package.</p>\\n<p>Here I will detail an example configuration to set up a GitHub to magit interface.</p>\\n<h1>GitHub</h1>\\n<p>This is the default, and probably most relevant.</p>"}`);export{c as comp,r as data};
